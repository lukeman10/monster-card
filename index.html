<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monster Card Collector</title>

<!-- PWA meta -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#222222">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
/* ---- GENERAL STYLING ---- */
body {
  font-family: sans-serif;
  background: linear-gradient(135deg, #222, #111, #222);
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 0;
}

h1 { margin-top: 20px; }
#cooldown { margin: 10px 0; font-size: 16px; }
#boosterButtons { margin-bottom: 20px; }
#cards { display: flex; flex-wrap: wrap; justify-content: center; }
h2 { width: 100%; text-align: left; margin-left: 20px; }

/* ---- BUTTONS ---- */
button {
  margin: 5px;
  padding: 10px 20px;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.1s ease, background 0.2s ease;
}
button:active {
  transform: scale(0.95);
  background: #555;
}
button:disabled {
  background: #444;
  cursor: not-allowed;
}

/* ---- CARDS ---- */
canvas.card {
  width: 100px;
  height: 140px;
  margin: 5px;
  border-radius: 10px;
  background: #333;
  touch-action: manipulation;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
}
canvas.card:hover, canvas.card:active {
  transform: scale(1.1);
  box-shadow: 0 8px 20px rgba(255, 255, 255, 0.3);
  z-index: 10;
}

/* ---- CARD GLOW BASED ON RARITY ---- */
canvas.card[data-rarity="Rare"] { box-shadow: 0 0 8px #4fc3f7; }
canvas.card[data-rarity="Epic"] { box-shadow: 0 0 10px #ba68c8; }
canvas.card[data-rarity="Legendary"] { box-shadow: 0 0 12px gold; }

/* ---- PULSING NEW BADGE ---- */
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}
canvas.card.new::after {
  content: "NEW";
  position: absolute;
  top: 5px;
  right: 5px;
  color: gold;
  font-weight: bold;
  animation: pulse 1s infinite;
}

/* ---- DUPLICATE MODAL ---- */
#dupeModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}
#dupeContent {
  background: #111;
  padding: 20px;
  border-radius: 16px;
  max-width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
}
#dupeCards {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}
.closeBtn {
  margin-top: 10px;
  padding: 10px 20px;
  border-radius: 10px;
  background: #444;
  color: #fff;
}
</style>
</head>

<body>

<h1>Monster Card Collector</h1>
<div id="cooldown">Next booster available: 0:00</div>
<div id="boosterButtons"></div>
<div id="cards"></div>

<!-- DUPLICATE MODAL -->
<div id="dupeModal">
  <div id="dupeContent">
    <h3 id="dupeTitle"></h3>
    <div id="dupeCards"></div>
    <button class="closeBtn" onclick="closeDupeModal()">Close</button>
  </div>
</div>

<!-- INSTALL BUTTON -->


<script>
// ---------- VERSION RESET ----------
const COLLECTION_VERSION = 2;
if ((parseInt(localStorage.getItem("collectionVersion")) || 0) < COLLECTION_VERSION) {
  localStorage.removeItem("cardCollection");
  localStorage.removeItem("nextBooster");
  localStorage.setItem("collectionVersion", COLLECTION_VERSION);
}

// ---------- GLOBALS ----------
let cards = [];
let collection = JSON.parse(localStorage.getItem("cardCollection")) || [];
let nextBooster = parseInt(localStorage.getItem("nextBooster") || 0);
const COOLDOWN_MS = 10 * 60 * 1000;

const cooldownEl = document.getElementById("cooldown");
const boosterDiv = document.getElementById("boosterButtons");
const cardsContainer = document.getElementById("cards");

const dupeModal = document.getElementById("dupeModal");
const dupeCardsDiv = document.getElementById("dupeCards");
const dupeTitle = document.getElementById("dupeTitle");

const installBtn = document.getElementById("installBtn");
let deferredPrompt;

// ---------- LOAD CARDS ----------
fetch("cards.json")
  .then(res => res.json())
  .then(data => {
    cards = data;
    setupBoosterButtons();
    updateCollectionUI();
  });

// ---------- BOOSTER BUTTONS ----------
function setupBoosterButtons(){
  const seriesList = [...new Set(cards.map(c => c.series))];
  seriesList.forEach(series => {
    const btn = document.createElement("button");
    btn.id = `btn-${series}`;
    btn.innerText = `Open ${series} Pack`;
    btn.onclick = () => openSeriesPack(series);
    boosterDiv.appendChild(btn);
  });
}

// ---------- COOLDOWN ----------
setInterval(() => {
  const remaining = nextBooster - Date.now();
  const disabled = remaining > 0;
  const seriesList = [...new Set(cards.map(c => c.series))];

  seriesList.forEach(series => {
    const btn = document.getElementById(`btn-${series}`);
    if (btn) btn.disabled = disabled;
  });

  const mins = Math.floor(Math.max(remaining,0)/60000);
  const secs = Math.floor((Math.max(remaining,0)%60000)/1000);
  cooldownEl.innerText = remaining > 0
    ? `Next booster available: ${mins}:${secs.toString().padStart(2,"0")}`
    : "Booster available!";
}, 1000);

// ---------- OPEN PACK ----------
function openSeriesPack(series){
  if (Date.now() < nextBooster) return;

  const seriesCards = cards.filter(c => c.series === series);
  const pack = [];

  for (let i=0;i<5;i++){
    pack.push(getRandomCardFromSeries(seriesCards));
  }

  collection.push(...pack);
  localStorage.setItem("cardCollection", JSON.stringify(collection));

  nextBooster = Date.now() + COOLDOWN_MS;
  localStorage.setItem("nextBooster", nextBooster);

  updateCollectionUI();
  alert(`You opened a ${series} pack:\n` +
    pack.map(c => `${c.name} (${c.rarity})`).join("\n"));
}

// ---------- RARITY ----------
function getRandomCardFromSeries(seriesCards){
  const r = Math.random();
  let rarity =
    r < 0.5 ? "Common" :
    r < 0.75 ? "Uncommon" :
    r < 0.9 ? "Rare" :
    r < 0.98 ? "Epic" : "Legendary";

  const pool = seriesCards.filter(c => c.rarity === rarity);
  return pool.length
    ? pool[Math.floor(Math.random()*pool.length)]
    : seriesCards[Math.floor(Math.random()*seriesCards.length)];
}

// ---------- UI ----------
function updateCollectionUI(){
  cardsContainer.innerHTML = "";
  const seriesList = [...new Set(collection.map(c => c.series))];

  seriesList.forEach(series => {
    const seriesCards = collection.filter(c => c.series === series);
    const map = {};

    seriesCards.forEach(c => {
      if (!map[c.id]) map[c.id] = { card: c, count: 0 };
      map[c.id].count++;
    });

    const header = document.createElement("h2");
    header.innerText =
      `${series} (${Object.keys(map).length}/${cards.filter(c=>c.series===series).length})`;
    cardsContainer.appendChild(header);

    Object.values(map).forEach(e =>
      drawCanvasCard(cardsContainer, e.card, e.count)
    );
  });
}

// ---------- DRAW CARD ----------
function drawCanvasCard(container, card, count){
  const canvas = document.createElement("canvas");
  canvas.className = "card";
  canvas.width = 100;
  canvas.height = 140;
  canvas.dataset.rarity = card.rarity;

  const ctx = canvas.getContext("2d");
  drawShape(ctx, card.color, card.shape);

  ctx.fillStyle = "#fff";
  ctx.font = "10px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText(card.name, 50, 110);
  ctx.fillText(card.rarity, 50, 122);

  // ----- DUPLICATE COUNTER / NEW BADGE -----
  if (count > 1){
    // Draw duplicate count in top-left corner
    ctx.fillStyle = "#fff";
    ctx.font = "bold 12px sans-serif";
    ctx.textAlign = "left";
    ctx.fillText(`x${count}`, 5, 15);

    // Clickable to show duplicates
    canvas.onclick = () => showDuplicates(card, count);
  } else {
    // Single copy = animated NEW badge via CSS
    canvas.classList.add("new");
  }

  container.appendChild(canvas);
}


// ---------- DUPLICATES ----------
function showDuplicates(card, count){
  dupeCardsDiv.innerHTML = "";
  dupeTitle.innerText = `${card.name} â€“ ${count} copies`;

  for (let i=0;i<count;i++){
    drawVariantCard(dupeCardsDiv, card, i);
  }

  dupeModal.style.display = "flex";
}

function closeDupeModal(){
  dupeModal.style.display = "none";
  dupeCardsDiv.innerHTML = "";
}

// ---------- VARIANT DRAW ----------
function adjustColor(hex, amt){
  let n = parseInt(hex.replace("#",""),16);
  let r = Math.min(255, Math.max(0,(n>>16)+amt));
  let g = Math.min(255, Math.max(0,((n>>8)&255)+amt));
  let b = Math.min(255, Math.max(0,(n&255)+amt));
  return `rgb(${r},${g},${b})`;
}

function drawVariantCard(container, card, index){
  const canvas = document.createElement("canvas");
  canvas.className = "card";
  canvas.width = 100;
  canvas.height = 140;
  const ctx = canvas.getContext("2d");

  drawShape(ctx, adjustColor(card.color, (index-2)*10), card.shape);

  ctx.fillStyle = "#fff";
  ctx.font = "10px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText(card.name, 50, 120);

  container.appendChild(canvas);
}

function drawShape(ctx, color, shape){
  ctx.fillStyle = color;
  const cx=50, cy=70, s=30;
  ctx.beginPath();
  if (shape==="circle") ctx.arc(cx,cy,s,0,Math.PI*2);
  if (shape==="triangle"){
    ctx.moveTo(cx,cy-s);
    ctx.lineTo(cx-s,cy+s);
    ctx.lineTo(cx+s,cy+s);
    ctx.closePath();
  }
  if (shape==="diamond"){
    ctx.moveTo(cx,cy-s);
    ctx.lineTo(cx-s,cy);
    ctx.lineTo(cx,cy+s);
    ctx.lineTo(cx+s,cy);
    ctx.closePath();
  }
  ctx.fill();
}

// ---------- SERVICE WORKER (PWA) ----------
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .catch(err => console.log("SW failed", err));
}

// ---------- INSTALL BUTTON ----------
// iOS instructions


</script>

</body>
</html>
